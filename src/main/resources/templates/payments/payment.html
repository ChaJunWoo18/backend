<!DOCTYPE html>
<html lang="en">
<head>
    <!-- PortOne SDK -->
    <script src="https://cdn.iamport.kr/v1/iamport.js"></script>
    <script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
    <script type="text/javascript" src="https://cdn.iamport.kr/js/iamport.payment-1.2.0.js"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>

    <script>
        const userCode = "imp38636483";
        var today = new Date();
        var hours = today.getHours(); // 시
        var minutes = today.getMinutes();  // 분
        var seconds = today.getSeconds();  // 초
        var milliseconds = today.getMilliseconds();
        var makeMerchantUid = "order_id_"+hours +  minutes + seconds + milliseconds;

        function saveMerchantUid(){
            $.ajax({
                url: "/saveMercantUid",
                data: {"merchantUid": makeMerchantUid},
                type: "post"
            });
        }
        saveMerchantUid() //DB에 merchantUid 등록

        IMP.init(userCode);

        async function requestPay() {
            await axios({
                url: "/payments/prepare",
                method: "post",
                headers: { "Content-Type": "application/json"},
                data: {
                    merchant_uid: makeMerchantUid, // 가맹점 주문번호
                    amount: 1004, // 결제 예정금액
                }
            });
            IMP.request_pay({
                pg: 'kakaopay.TC0ONETIME',
                pay_method: 'card',
                merchant_uid: makeMerchantUid, //상점에서 생성한 고유 주문번호
                name: '주문명:결제테스트',   //필수 파라미터 입니다.
                amount: 1004,
                buyer_email: 'iamport@siot.do',
                buyer_name: '구매자이름',
                buyer_tel: '010-1234-5678',
                buyer_addr: '서울특별시 강남구 삼성동',
                buyer_postcode: '123-456',
            }, function (rsp) {
                console.log("rsp",rsp);
                // 결제검증
                $.ajax({
                    type: "POST",
                    url: "/verifyIamport/" + rsp.imp_uid
                }).done(function (data) {
                    console.log("data", data);
                    // 위의 rsp.paid_amount 와 data.response.amount를 비교한후 로직 실행 (import 서버검증)
                    if (rsp.paid_amount === data.paid_amount) {
                        console.log("결제검증완료")
                        alert("결제 및 결제검증완료");
                    } else {
                        alert("결제 실패");
                    }
                });
            });
        }
    </script>
    <meta charset="UTF-8">
    <title>Sample Payment</title>
</head>
<body>
<button onclick="requestPay()">결제하기</button> <!-- 결제하기 버튼 생성 -->
</body>
</html>