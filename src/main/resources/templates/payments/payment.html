<!DOCTYPE html>
<html lang="en">
<head>
    <!-- PortOne SDK -->
    <script src="https://cdn.iamport.kr/v1/iamport.js"></script>
    <script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
    <script type="text/javascript" src="https://cdn.iamport.kr/js/iamport.payment-1.2.0.js"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>

    <script>
        const userCode = "imp38636483";
        var today = new Date();
        var hours = today.getHours(); // 시
        var minutes = today.getMinutes();  // 분
        var seconds = today.getSeconds();  // 초
        var milliseconds = today.getMilliseconds();
        var makeMerchantUid = "order_id_"+hours +  minutes + seconds + milliseconds;
        var Testamount = 10000;

        function saveMerchantUid(){
            $.ajax({
                url: "/saveMercantUid",
                data: {"merchantUid": makeMerchantUid},
                type: "post"
            });
        }
        saveMerchantUid() //DB에 merchantUid 등록

        function requestPay() {
            axios({
                url: "/payments/prepare",
                method: "post",
                headers: {"Content-Type": "application/json"},
                data: {
                    merchant_uid: makeMerchantUid, // 가맹점 주문번호
                    amount: Testamount, // 결제 예정금액
                }
            }).then(response=> {
                axios({
                    url: "/payments/prepare/"+makeMerchantUid,
                    method: "get",
                    headers: {"Content-Type": "application/json"}
                }).then(response=> {
                    if(makeMerchantUid!=response.data.merchant_uid ||
                         response.data.amount !=Testamount) {
                        alert("결제 정보가 올바르지 않습니다. \n" +
                            "다시 시도해주세요")
                        window.location.href='http://localhost:8080/pay';
                    }
                })
            }).catch(err=> {
                alert("결제 서버가 불안정합니다. 나중에 시도하세요")
            })
            IMP.init(userCode);
            IMP.request_pay({
                pg: 'kakaopay.TC0ONETIME',
                pay_method: 'card',
                merchant_uid: makeMerchantUid, //상점에서 생성한 고유 주문번호
                name: '주문명:결제테스트',   //필수 파라미터 입니다.
                amount: 10000,
                buyer_email: 'iamport@siot.do',
                buyer_name: '구매자이름',
                buyer_tel: '010-1234-5678'
            }, function (rsp) {
                console.log(rsp)
                var imp_uid = rsp.imp_uid
                // 결제 사후검증
                $.ajax({
                    type: "POST",
                    url: "/verifyIamport/" + rsp.imp_uid
                }).done(function (response) {
                    console.log(response)
                    // 위의 rsp.paid_amount 와 data.response.amount를 비교한후 로직 실행 (import 서버검증)
                    if (rsp.paid_amount === response.amount) {
                        console.log("결제 완료")
                        $.ajax({
                            type: "POST",
                            url: "/paySuccess/" + imp_uid
                        })
                    } else {
                        alert("결제 실패");
                    }
                });
            });
        }

    //    환불로직
        function cancelPay() {
            jQuery.ajax({
                "url": "/payments/cancel",
                "type": "POST",
                "contentType": "application/json",
                "data": JSON.stringify({
                    "merchant_uid": makeMerchantUid, // 예: ORD20180131-0000011
                    "cancel_request_amount": Testamount, // 환불금액
                    //테스트 데이터인 관계로 아래는 사용하지 않음.
                    //"reason": "테스트 결제 환불" // 환불사유
                    // [가상계좌 환불시 필수입력] 환불 수령계좌 예금주
                    //"refund_holder": "홍길동",
                    // [가상계좌 환불시 필수입력] 환불 수령계좌 은행코드(예: KG이니시스의 경우 신한은행은 88번)
                    //"refund_bank": "88"
                    // [가상계좌 환불시 필수입력] 환불 수령계좌 번호
                    //"refund_account": "56211105948400"
                }),
                "dataType": "json"
            });
        }
    </script>
    <meta charset="UTF-8">
    <title>Sample Payment</title>
</head>
<body>
<button onclick="requestPay()">결제하기</button>
<button onclick="cancelPay()">환불하기</button>
</body>
</html>